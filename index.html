<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CFBBA Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#f6f7fb;--card:#fff;--line:#e6e8ef;--head:#f1f3f8;--muted:#667085;--accent:#3b82f6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:#111}

  header{position:sticky;top:0;z-index:30;display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px;background:#fff;border-bottom:1px solid var(--line)}
  button,select,input[type="date"]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  button:hover{background:#fafafa}
  .filters{margin-left:auto;display:flex;gap:8px}
  .muted{color:var(--muted);font-size:12px}

  .wrap{padding:12px}
  .error{background:#fff3f3;border:1px solid #f5c2c7;color:#842029;padding:8px 10px;border-radius:8px;margin:8px 12px;display:none}

  /* Schedule shell */
  .sched{background:var(--card);border:1px solid var(--line);box-shadow:0 2px 6px rgba(0,0,0,.06)}

  /* Sticky top header (time label + scrolling field headers) */
  .head{position:sticky;top:54px;z-index:20;display:flex;align-items:stretch;border-bottom:1px solid var(--line);background:var(--head);overflow:hidden}
  .timeHead{flex:0 0 82px;display:flex;align-items:center;justify-content:center;font-weight:700;border-right:1px solid var(--line);background:#fbfbff;position:sticky;left:0;z-index:25}
  .headCols{display:grid;grid-auto-columns:minmax(140px,1fr);grid-auto-flow:column;will-change:transform}
  .colHead{padding:10px 8px;border-right:1px solid rgba(255,255,255,.35);font-weight:700;white-space:nowrap;background:var(--head)}

  /* Grid scroller */
  .body{
    display:flex;align-items:stretch;position:relative;
    overflow-x:auto;              /* horizontal scroll */
    overflow-y:auto;              /* vertical scroll inside grid */
    -webkit-overflow-scrolling:touch;
    overscroll-behavior:contain;
    touch-action:pan-x pan-y;
    height: 60vh;                 /* JS will refine height */
  }
  .timeRail{flex:0 0 82px;position:sticky;left:0;z-index:15;border-right:1px solid var(--line);background:#fbfbff}
  .timeRailInner{position:relative}
  .timeTick{position:absolute;left:0;right:0;height:0;border-top:1px solid var(--line)}
  .timeLabel{position:absolute;left:8px;transform:translateY(-50%);font-weight:700}

  .cols{display:grid;grid-auto-columns:minmax(140px,1fr);grid-auto-flow:column;position:relative}
  .col{
    position:relative;border-right:1px solid var(--line);
    background:repeating-linear-gradient(
      to bottom, transparent 0, transparent calc(var(--hourPx) - 1px),
      rgba(0,0,0,0.05) calc(var(--hourPx) - 1px), rgba(0,0,0,0.05) var(--hourPx)
    );
  }

  .event{
    position:absolute;left:0;right:6px;
    background:var(--fieldColor, #eef2ff); /* colored per field */
    border-left:4px solid rgba(255,255,255,.35);
    border-radius:10px;padding:6px 8px;font-size:13px;line-height:1.25;overflow:hidden;margin:0;cursor:pointer;
    color:#fff;
  }
  .event .time{font-size:11px;opacity:.9;margin-bottom:2px}
  .event .title{font-weight:700}
  .event .muted{font-size:11px;color:rgba(255,255,255,.9)}
  .event:focus{outline:2px solid rgba(255,255,255,.6)}
  .event[data-level]{right:auto}

  /* Details sheet (modal) */
  .sheetBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
  .sheet{
    position:fixed;left:50%;transform:translateX(-50%);bottom:0;right:0;max-width:720px;
    background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -8px 24px rgba(0,0,0,.2);padding:16px;z-index:60;display:none;
    max-height:80vh;overflow:auto;-webkit-overflow-scrolling:touch;
  }
  .sheet h3{margin:0 0 4px 0}
  .sheet .meta{color:var(--muted);font-size:13px;margin-bottom:10px}
  .sheet .desc{white-space:pre-wrap;word-wrap:break-word}
  .sheet a{color:#0a58ca;text-decoration:underline;word-break:break-word}
  .sheet .close{position:sticky;top:0;display:flex;justify-content:flex-end;margin:-16px -16px 8px 0;padding:8px}
  .sheet .close button{border-radius:8px}

  @media (max-width: 640px){
    .cols, .headCols{grid-auto-columns:minmax(120px,1fr)}
    .event{font-size:12px}
  }
</style>
</head>
<body>

<header>
  <button id="prevDay">◀ Day</button>
  <button id="today">Today</button>
  <button id="nextDay">Day ▶</button>
  <button id="prevGame">◀ Games</button>
  <button id="nextGame">Games ▶</button>
  <input type="date" id="picker" />
  <div class="filters">
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="divisionFilter"><option value="">All Divisions</option></select>
  </div>
  <span id="status" class="muted">Loading…</span>
</header>

<div id="err" class="error"></div>

<div class="wrap">
  <div class="sched">
    <div class="head">
      <div class="timeHead">Time</div>
      <div id="headCols" class="headCols"></div>
    </div>
    <div id="body" class="body" style="--hourPx:60px">
      <div class="timeRail">
        <div id="timeRailInner" class="timeRailInner"></div>
      </div>
      <div id="cols" class="cols"></div>
    </div>
  </div>
</div>

<!-- Details sheet -->
<div id="sheetBack" class="sheetBack" aria-hidden="true"></div>
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
  <div class="close"><button id="sheetClose">Close ✕</button></div>
  <h3 id="sheetTitle"></h3>
  <div id="sheetMeta" class="meta"></div>
  <div id="sheetDesc" class="desc"></div>
</div>

<script>
/* ====== Config ====== */
const PROXY_URL = "https://script.google.com/macros/s/AKfycbzOT2O1_ADT2APncQpqu4NQKLoIUPzQNz7gFB4M0vdHtfD2wR9zY-Ia5P6Wwl8HGf1T/exec";
const START_HOUR = 7;
const END_HOUR   = 22;
const PX_PER_MIN = 1;
const REFRESH_MS = 60000;

/* ====== State ====== */
let currentDay = new Date();
let allEvents = [], gameDates = [], fields = [];

/* ====== Utils ====== */
const pad=n=>String(n).padStart(2,"0");
const localYMD=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const addDays=(d,n)=>{const x=new Date(d); x.setDate(d.getDate()+n); return x;};
const fmtTime=d=>new Intl.DateTimeFormat([], {hour:"numeric", minute:"2-digit"}).format(d);
const uniq=arr=>[...new Set(arr)];
const nonEmpty=s=>s && String(s).trim().length>0;
function showError(msg){ const box=document.getElementById("err"); box.style.display="block"; box.textContent=msg; }
function clearError(){ const box=document.getElementById("err"); box.style.display="none"; box.textContent=""; }

/* Make URLs clickable in the sheet */
function linkify(text){
  if(!text) return "";
  const urlRe = /(https?:\/\/[^\s<>()]+)|((?:www\.)[^\s<>()]+)/gi;
  return text.replace(urlRe,(m)=>{
    const url = m.startsWith('http') ? m : `http://${m}`;
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${m}</a>`;
  });
}

/* ---------- Division / Schedule helpers ---------- */

/* Normalize & validate a candidate division */
function normalizeDivision(s){
  if(!s) return "";
  s = s.replace(/[–—]/g,'-').replace(/\s+/g,' ').trim();

  // 4U..18U
  let m = /^(\d{1,2})\s*[Uu]\b(?:\s*(AA|AAA|A|B|C|Gold|Silver|Bronze|American|National))?$/i.exec(s);
  if(m){
    const age = +m[1];
    if(age>=4 && age<=18) return `${age}U${m[2] ? ' ' + m[2].toUpperCase() : ''}`;
    return "";
  }

  // 7/8..18/18 with optional A/AA/AAA (glued or spaced) + optional descriptor
  m = /^(\d{1,2})\s*[\/-]\s*(\d{1,2})\s*(?:([Aa]{1,3}|[ABC]))?(?:\s*(American|National|Gold|Silver|Bronze))?$/i.exec(s);
  if(m){
    const a = +m[1], b = +m[2];
    if(a>=7 && a<=18 && b>=7 && b<=18){
      const grade = m[3] ? ' ' + m[3].toUpperCase() : '';
      const desc  = m[4] ? ' ' + m[4] : '';
      return `${a}/${b}${grade}${desc}`.trim();
    }
    return "";
  }

  return "";
}

/* Prefer schedule name straight from the payload (if present) */
function scheduleFromEvent(ev){
  const keys = [
    'schedule','scheduleName','schedule_name',
    'division','divisionName',
    'calendar','calendarName','calendarSummary',
    'calendar_title','calendarTitle','league','ageDivision'
  ];
  for(const k of keys){
    if(k in ev){
      const v = ev[k];
      if(typeof v === 'string' && v.trim()) return v.trim();
      if(v && typeof v === 'object'){
        for(const nk of ['summary','name','title']){
          if(typeof v[nk] === 'string' && v[nk].trim()) return v[nk].trim();
        }
      }
    }
  }
  return '';
}

/* Fallback: scan text but validate strictly */
function detectDivisionAnywhere(text){
  if(!text) return "";
  const norm = text.replace(/[–—]/g,'-');

  const cands = [];
  let m;

  const broadSlash = /(\d{1,2}\s*[\/-]\s*\d{1,2}\s*(?:[Aa]{1,3}|[ABC])?(?:\s*(?:American|National|Gold|Silver|Bronze))?)/ig;
  while((m=broadSlash.exec(norm))) cands.push(m[1]);

  const broadU = /(\d{1,2}\s*[Uu](?:\s*(?:AA|AAA|A|B|C|Gold|Silver|Bronze|American|National))?)/ig;
  while((m=broadU.exec(norm))) cands.push(m[1]);

  const val = cands.map(normalizeDivision).filter(Boolean);
  if(!val.length) return "";
  val.sort((a,b)=>b.length-a.length);
  return val[0];
}

function resolveDivisionFrom(title, desc, scheduleRaw){
  // 1) Schedule field from payload (strongest signal)
  if(scheduleRaw){
    const n = normalizeDivision(scheduleRaw) || scheduleRaw.trim();
    if(n) return n;
  }
  // 2) Try in description
  const fromDesc = detectDivisionAnywhere(desc);
  if(fromDesc) return fromDesc;
  // 3) Finally try title
  const fromTitle = detectDivisionAnywhere(title);
  return fromTitle || "";
}

/* ---------- Field helpers ---------- */
function fieldFromDescription(desc){ if(!desc) return ""; const parts=desc.split(">").map(s=>s.trim()).filter(Boolean); return parts.length?parts[parts.length-1]:""; }
function guessFieldFromText(title, location){
  const hay=(title||"")+" | "+(location||""); let m;
  if (/\bpepper\b.*\bnorth\b/i.test(hay)) return "Pepper North";
  if (/\bpepper\b.*\bsouth\b/i.test(hay)) return "Pepper South";
  if (m=hay.match(/\bmcinnish\b.*\bfield\s*(\d{1,2})\b/i)) return `McInnish Baseball Field ${m[1]}`;
  if (m=hay.match(/\bmac(arthur)?\b.*\b(\d{1,2})\b/i)) return `Mac ${m[2]}`;
  if (/\brdl\b/i.test(hay)) return "RDL";
  if (/\bjaycee\b/i.test(hay)) return "Jaycee Park";
  return (location||"").split(",")[0].trim();
}
function smartSort(a,b){ const key=s=>{ const m=s.match(/^([A-Za-z ]+?)(?:\s+(\d+))?$/); return [(m?.[1]||s).trim().toLowerCase(), Number(m?.[2]||0)]; }; const ka=key(a), kb=key(b); return ka[0]===kb[0]? ka[1]-kb[1] : (ka[0]<kb[0]? -1:1); }

/* ====== Field colors (deterministic) ====== */
const FIELD_PALETTE = ['#0ea5e9','#ef4444','#10b981','#6366f1','#f59e0b','#14b8a6','#6d28d9','#84cc16','#f97316','#1f7a8c','#e11d48','#22c55e'];
function colorForField(name){
  if(!name) return '#3b82f6';
  let h=0; for(let i=0;i<name.length;i++) h=(h*31 + name.charCodeAt(i))>>>0;
  return FIELD_PALETTE[h % FIELD_PALETTE.length];
}

/* ====== Fetch from proxy ====== */
async function fetchEvents(){
  clearError(); const statusEl=document.getElementById("status"); statusEl.textContent="Loading…";
  try{
    const now=new Date();
    const min=new Date(now.getFullYear()-1, now.getMonth(), now.getDate());
    const max=new Date(now.getFullYear()+1, now.getMonth(), now.getDate());
    const url = `${PROXY_URL}?timeMin=${encodeURIComponent(min.toISOString())}&timeMax=${encodeURIComponent(max.toISOString())}`;
    const res = await fetch(url);
    if(!res.ok){ showError(`Proxy error (${res.status}).`); statusEl.textContent="Proxy error."; return; }
    const data = await res.json();
    if(!data || !Array.isArray(data.items)){ showError("Proxy returned unexpected data."); statusEl.textContent="Bad data."; return; }

allEvents = data.items.map(ev=>{
  const start = ev.start ? new Date(ev.start) : null;
  const end   = ev.end   ? new Date(ev.end)   : start;
  const title = ev.title || "", loc = ev.location || "", desc = ev.description || "";

  // NEW: take the true schedule name straight from the proxy if present
  const schedule = (ev.schedule || "").trim();

  // Use schedule as division (fallback to the previous resolver so nothing breaks)
  const div = schedule || resolveDivisionFrom(title, desc, schedule);

  let field = fieldFromDescription(desc);
  if (!field) field = guessFieldFromText(title, loc);

  return { s:start, e:end, t:title, l:loc, desc, div, field, schedule, calendarName: ev.calendarName || "" };
}).filter(e => e.s && e.e);

    fields = uniq(allEvents.map(e=>e.field).filter(nonEmpty)).sort(smartSort);
    gameDates = uniq(allEvents.map(e=>localYMD(e.s))).sort();

    populateFilters();
    render();
    statusEl.textContent=`Loaded ${allEvents.length} events • ${fields.length} fields • ${gameDates.length} game days`;
  }catch(err){ console.error(err); showError("JavaScript error: "+err.message); document.getElementById("status").textContent="Error."; }
}

/* ====== UI ====== */
function populateFilters(){
  const $f=document.getElementById("fieldFilter");
  $f.innerHTML='<option value="">All Fields</option>'+fields.map(f=>`<option>${f}</option>`).join("");
  const divisions=uniq(allEvents.map(e=>e.div).filter(nonEmpty)).sort();
  const $d=document.getElementById("divisionFilter");
  $d.innerHTML='<option value="">All Divisions</option>'+divisions.map(d=>`<option>${d}</option>`).join("");
}

/* Overlap layout per field */
function layoutLevels(events){
  const levels=[]; const placed=[];
  events.sort((a,b)=>a.s-b.s).forEach(ev=>{
    let lvl=0; while(lvl<levels.length && ev.s < levels[lvl]) lvl++;
    levels[lvl]=ev.e; placed.push({ev, level:lvl});
  });
  return { placed, levelCount: Math.max(1, levels.length) };
}

/* ====== Render ====== */
function render(){
  const iso=localYMD(currentDay);
  const fieldFilter=document.getElementById("fieldFilter").value;
  const divFilter=document.getElementById("divisionFilter").value;

  const dayStart0=new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),0,0,0,0);
  const dayEnd0  =new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),23,59,59,999);
  const dayStart =new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),START_HOUR,0,0,0);
  const dayEnd   =new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),END_HOUR,0,0,0);
  const totalMin=(END_HOUR-START_HOUR)*60;

  const dayEvents = allEvents
    .filter(ev => ev.e > dayStart0 && ev.s < dayEnd0)
    .filter(ev => !divFilter || ev.div===divFilter)
    .filter(ev => !fieldFilter || ev.field===fieldFilter);

  const colsList = fieldFilter ? [fieldFilter] : fields.slice();

  /* Sticky header field labels (color-coded) */
  const headCols = document.getElementById("headCols");
  headCols.innerHTML = colsList.map(f=>{
    const c = colorForField(f);
    return `<div class="colHead" style="background:${c};color:#fff">${f}</div>`;
  }).join("");

  /* Time rail */
  const hourPx = 60*PX_PER_MIN;
  document.getElementById("body").style.setProperty('--hourPx', hourPx+'px');
  const railInner=document.getElementById("timeRailInner");
  railInner.style.height = (PX_PER_MIN*totalMin) + "px";
  railInner.innerHTML = "";
  for(let h=START_HOUR; h<=END_HOUR; h++){
    const y=(h-START_HOUR)*hourPx;
    railInner.insertAdjacentHTML("beforeend", `<div class="timeTick" style="top:${y}px"></div>`);
    if(h<END_HOUR){
      const dt=new Date(2000,0,1,h,0,0);
      railInner.insertAdjacentHTML("beforeend", `<div class="timeLabel" style="top:${y}px">${new Intl.DateTimeFormat([], {hour:'numeric'}).format(dt)}</div>`);
    }
  }

  /* Columns + events */
  const cols = document.getElementById("cols");
  cols.style.gridAutoColumns = 'minmax(140px,1fr)';
  cols.innerHTML = "";
  colsList.forEach(field=>{
    const col=document.createElement('div');
    col.className='col';
    col.style.height = (PX_PER_MIN*totalMin) + "px";

    const fieldColor = colorForField(field);
    col.style.setProperty('--fieldColor', fieldColor);

    const es = dayEvents.filter(e=>e.field===field).map(e=>{
      const s = new Date(Math.max(e.s, dayStart));
      const eEnd = new Date(Math.min(e.e, dayEnd));
      return {...e, s, e:eEnd};
    }).filter(e=>e.e>e.s);

    const { placed, levelCount } = layoutLevels(es);

    placed.forEach(({ev, level})=>{
      const topMin  = (ev.s - dayStart)/60000;
      const endMin  = (ev.e - dayStart)/60000;
      const topPx   = Math.round(topMin * PX_PER_MIN * 10) / 10;
      const height  = Math.max(2, Math.round((endMin - topMin) * PX_PER_MIN * 10) / 10);

      const gap=4, widthPct=100/levelCount, leftPct=widthPct*level;

      const node=document.createElement('div');
      node.className='event';
      node.style.top = topPx+'px';
      node.style.height = height+'px';
      node.style.left = `calc(${leftPct}% + ${gap/2}px)`;
      node.style.width = `calc(${widthPct}% - ${gap}px)`;
      node.setAttribute('data-level', level);
      node.setAttribute('tabindex','0');
      node.title = (ev.l||"").replace(/\s+/g," ").trim();

      node.innerHTML = `
        <div class="time">${fmtTime(ev.s)} – ${fmtTime(ev.e)}</div>
        <div class="title">${ev.t}</div>
        ${ev.div ? `<div class="muted">${ev.div}</div>` : ""}
      `;

      const open = ()=>openSheet(ev);
      node.addEventListener('click', open);
      node.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); } });

      col.appendChild(node);
    });

    cols.appendChild(col);
  });

  /* Sync header scroll with body (field names move with columns) */
  const bodyEl=document.getElementById("body");
  bodyEl.onscroll = () => { headCols.style.transform = `translateX(${-bodyEl.scrollLeft}px)`; };

  adjustGridHeight();

  document.getElementById("status").textContent=`Showing ${iso} • ${dayEvents.length} events`;
}

/* Fit grid to viewport so vertical scroll stays inside the table */
function adjustGridHeight(){
  const headerH = document.querySelector('header')?.offsetHeight || 0;
  const headH   = document.querySelector('.head')?.offsetHeight || 0;
  const totalOffset = headerH + headH + 24;
  document.getElementById('body').style.height = Math.max(240, window.innerHeight - totalOffset) + 'px';
}

/* ====== Details Sheet ====== */
const sheet = document.getElementById('sheet');
const sheetBack = document.getElementById('sheetBack');
const sheetClose = document.getElementById('sheetClose');

function openSheet(ev){
  document.getElementById('sheetTitle').textContent = ev.t || '(No title)';
  const metaParts = [
    `${fmtTime(ev.s)} – ${fmtTime(ev.e)}`,
    ev.field ? `• ${ev.field}` : '',
    ev.div ? `• <strong>${ev.div}</strong>` : ''
  ].filter(Boolean);
  const locLine = ev.l ? `<br>Location: ${ev.l}` : '';
  document.getElementById('sheetMeta').innerHTML = metaParts.join(' ') + locLine;
  document.getElementById('sheetDesc').innerHTML = ev.desc ? linkify(ev.desc) : '<span class="muted">No description.</span>';

  sheetBack.style.display='block';
  sheet.style.display='block';
  sheet.focus();
}
function closeSheet(){ sheet.style.display='none'; sheetBack.style.display='none'; }
sheetBack.addEventListener('click', closeSheet);
sheetClose.addEventListener('click', closeSheet);

/* ====== Navigation ====== */
function jumpToGame(next=true){
  if(!gameDates.length)return;
  const iso=localYMD(currentDay);
  if(next){const nxt=gameDates.find(d=>d>iso);if(nxt){currentDay=new Date(nxt+"T12:00:00");document.getElementById("picker").value=nxt;render();}}
  else{const prev=[...gameDates].reverse().find(d=>d<iso);if(prev){currentDay=new Date(prev+"T12:00:00");document.getElementById("picker").value=prev;render();}}
}

/* ====== Wire up ====== */
document.getElementById("picker").value=localYMD(currentDay);
document.getElementById("prevDay").onclick=()=>{ currentDay=addDays(currentDay,-1); document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("nextDay").onclick=()=>{ currentDay=addDays(currentDay, 1); document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("today").onclick  =()=>{ currentDay=new Date();           document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("prevGame").onclick=()=> jumpToGame(false);
document.getElementById("nextGame").onclick=()=> jumpToGame(true);
document.getElementById("fieldFilter").onchange=render;
document.getElementById("divisionFilter").onchange=render;
document.getElementById("picker").onchange = e=>{ currentDay=new Date(e.target.value+"T12:00:00"); render(); };
window.addEventListener('resize', adjustGridHeight);

/* ====== Init ====== */
fetchEvents();
setInterval(fetchEvents, REFRESH_MS);
</script>
</body>
</html>
