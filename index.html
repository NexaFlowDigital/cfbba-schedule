<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CFBBA Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0}
header{padding:10px;background:#fff;border-bottom:1px solid #ccc;position:sticky;top:0;display:flex;flex-wrap:wrap;gap:10px;align-items:center;z-index:3}
button,select,input[type=date]{padding:6px 10px;border:1px solid #ccc;border-radius:5px;cursor:pointer}
.grid{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.grid th,.grid td{border:1px solid #ddd;vertical-align:top;padding:6px}
.grid thead th{background:#f0f2f5;position:sticky;top:50px;z-index:2}
.time-col{width:70px;background:#fafafa;font-weight:600;text-align:center}
.event{background:#e8f0fe;border-left:4px solid #4285f4;margin:3px 0;padding:4px 6px;border-radius:4px;font-size:13px}
.event .title{font-weight:600}
.filters{margin-left:auto;display:flex;gap:10px}
</style>
</head>
<body>
<header>
  <button id="prevDay">◀ Day</button>
  <button id="today">Today</button>
  <button id="nextDay">Day ▶</button>
  <button id="prevGame">◀ Games</button>
  <button id="nextGame">Games ▶</button>
  <input type="date" id="picker">
  <div class="filters">
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="divisionFilter"><option value="">All Divisions</option></select>
  </div>
  <span id="status"></span>
</header>
<table class="grid" id="grid"></table>

<script>
const FEED_URL = "https://calendar.bluesombrero.com/api/v1/Calendar?instancekey=leagues&portalId=81458&id=46369345&key=YSOC5AJG";

const START_HOUR=7, END_HOUR=22;
let currentDay=new Date(), eventsAll=[], fields=[], gameDates=[];

function toISO(d){return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);}
function addDays(d,n){let x=new Date(d);x.setDate(x.getDate()+n);return x;}
function fmtTime(d){return new Intl.DateTimeFormat([], {hour:"numeric",minute:"2-digit"}).format(d);}
function detectDivision(summary){let m=summary.match(/\b(\d{2}U)\b/i);return m?m[1].toUpperCase():"";}
function detectField(ev){
  for(const f of fields){if((ev.l||"").includes(f)||(ev.t||"").includes(f)) return f;}
  return null;
}
function uniq(arr){return [...new Set(arr)]}

async function load(){
  document.getElementById("status").textContent="Loading…";
  const txt=await fetch(FEED_URL,{cache:"no-store"}).then(r=>r.text());
  const jcal=ICAL.parse(txt);const comp=new ICAL.Component(jcal);
  eventsAll=comp.getAllSubcomponents("vevent").map(v=>new ICAL.Event(v))
    .map(e=>({s:e.startDate.toJSDate(),e:e.endDate.toJSDate(),t:e.summary||"",l:e.location||"",division:detectDivision(e.summary||"")}));
  
  // auto-detect fields
  fields=uniq(eventsAll.map(ev=>ev.l).concat(eventsAll.map(ev=>{
    const m=ev.t.match(/@(.+)/);return m?m[1].trim():"";
  }))).filter(x=>x);
  fields.sort();
  
  // auto-detect game dates
  gameDates=uniq(eventsAll.map(ev=>toISO(ev.s))).sort();
  
  populateFilters();
  render();
}
function populateFilters(){
  document.getElementById("fieldFilter").innerHTML='<option value="">All Fields</option>'+fields.map(f=>`<option>${f}</option>`).join("");
  const divisions=uniq(eventsAll.map(e=>e.division).filter(x=>x)).sort();
  document.getElementById("divisionFilter").innerHTML='<option value="">All Divisions</option>'+divisions.map(d=>`<option>${d}</option>`).join("");
}
function render(){
  const iso=toISO(currentDay), dayStart=new Date(iso+"T00:00"), dayEnd=new Date(iso+"T23:59");
  const fieldFilter=document.getElementById("fieldFilter").value;
  const divFilter=document.getElementById("divisionFilter").value;
  const list=eventsAll.filter(ev=>ev.e>dayStart&&ev.s<dayEnd)
    .filter(ev=>!fieldFilter||detectField(ev)===fieldFilter)
    .filter(ev=>!divFilter||ev.division===divFilter);
  
  const byField={};fields.forEach(f=>byField[f]=[]);
  list.forEach(ev=>{const f=detectField(ev);if(f)byField[f].push(ev);});
  
  const hrs=[...Array(END_HOUR-START_HOUR+1)].map((_,i)=>START_HOUR+i);
  let html="<thead><tr><th class='time-col'>Time</th>"+fields.map(f=>"<th>"+f+"</th>").join("")+"</tr></thead><tbody>";
  for(const h of hrs){
    const slotStart=new Date(currentDay);slotStart.setHours(h,0,0,0);
    const slotEnd=new Date(currentDay);slotEnd.setHours(h+1,0,0,0);
    html+="<tr><th class='time-col'>"+new Intl.DateTimeFormat([], {hour:"numeric"}).format(slotStart)+"</th>";
    for(const f of fields){
      const cell=(byField[f]||[]).filter(ev=>ev.e>slotStart&&ev.s<slotEnd)
        .map(ev=>`<div class="event"><div class="time">${fmtTime(ev.s)}–${fmtTime(ev.e)}</div><div class="title">${ev.t}</div><div>${ev.division||""}</div></div>`).join("");
      html+="<td>"+cell+"</td>";
    }
    html+="</tr>";
  }
  html+="</tbody>";
  document.getElementById("grid").innerHTML=html;
  document.getElementById("status").textContent=`Showing ${iso} • ${list.length} events`;
}

function jumpToGame(next=true){
  if(gameDates.length===0) return;
  const iso=toISO(currentDay);
  if(next){
    const nxt=gameDates.find(d=>d>iso);
    if(nxt){currentDay=new Date(nxt);document.getElementById("picker").value=nxt;render();}
  } else {
    const prev=[...gameDates].reverse().find(d=>d<iso);
    if(prev){currentDay=new Date(prev);document.getElementById("picker").value=prev;render();}
  }
}

document.getElementById("prevDay").onclick=()=>{currentDay=addDays(currentDay,-1);document.getElementById("picker").value=toISO(currentDay);render();}
document.getElementById("nextDay").onclick=()=>{currentDay=addDays(currentDay,1);document.getElementById("picker").value=toISO(currentDay);render();}
document.getElementById("today").onclick=()=>{currentDay=new Date();document.getElementById("picker").value=toISO(currentDay);render();}
document.getElementById("picker").onchange=e=>{currentDay=new Date(e.target.value+"T12:00:00");render();}
document.getElementById("fieldFilter").onchange=render;
document.getElementById("divisionFilter").onchange=render;
document.getElementById("prevGame").onclick=()=>jumpToGame(false);
document.getElementById("nextGame").onclick=()=>jumpToGame(true);
document.getElementById("picker").value=toISO(currentDay);

load();
setInterval(load,60000);
</script>
</body>
</html>
