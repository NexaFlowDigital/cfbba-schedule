<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CFBBA Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#f6f7fb;--card:#fff;--line:#e6e8ef;--head:#f1f3f8;--muted:#667085;--accent:#3b82f6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:#111}

  header{position:sticky;top:0;z-index:30;display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px;background:#fff;border-bottom:1px solid var(--line)}
  button,select,input[type="date"]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  button:hover{background:#fafafa}
  .filters{margin-left:auto;display:flex;gap:8px}
  .muted{color:var(--muted);font-size:12px}

  .wrap{padding:12px}
  .error{background:#fff3f3;border:1px solid #f5c2c7;color:#842029;padding:8px 10px;border-radius:8px;margin:8px 12px;display:none}

  /* Schedule shell */
  .sched{background:var(--card);border:1px solid var(--line);box-shadow:0 2px 6px rgba(0,0,0,.06)}
  /* Sticky top header (time label + scrolling field headers) */
  .head{position:sticky;top:54px;z-index:20;display:flex;align-items:stretch;border-bottom:1px solid var(--line);background:var(--head);overflow:hidden}
  .timeHead{flex:0 0 82px;display:flex;align-items:center;justify-content:center;font-weight:700;border-right:1px solid var(--line);background:#fbfbff;position:sticky;left:0;z-index:25}
  .headCols{display:grid;grid-auto-columns:minmax(140px,1fr);grid-auto-flow:column;will-change:transform}

  .colHead{padding:10px 8px;border-right:1px solid var(--line);font-weight:700;white-space:nowrap;background:var(--head)}

  /* Body (horizontal scroll area) */
  .body{display:flex;align-items:stretch;overflow-x:auto;position:relative}
  .timeRail{flex:0 0 82px;position:sticky;left:0;z-index:15;border-right:1px solid var(--line);background:#fbfbff}
  .timeRailInner{position:relative}
  .timeTick{position:absolute;left:0;right:0;height:0;border-top:1px solid var(--line)}
  .timeLabel{position:absolute;left:8px;transform:translateY(-50%);font-weight:700}

  .cols{display:grid;grid-auto-columns:minmax(140px,1fr);grid-auto-flow:column;position:relative}
  .col{position:relative;border-right:1px solid var(--line);background:
    repeating-linear-gradient(to bottom, transparent 0, transparent calc(var(--hourPx) - 1px), rgba(0,0,0,0.05) calc(var(--hourPx) - 1px), rgba(0,0,0,0.05) var(--hourPx));
  }

  .event{
    position:absolute;left:0;right:6px;background:#eef2ff;border-left:4px solid var(--accent);
    border-radius:10px;padding:6px 8px;font-size:13px;line-height:1.25;overflow:hidden;margin:0
  }
  .event .title{font-weight:700}
  .event[data-level]{right:auto}
</style>
</head>
<body>

<header>
  <button id="prevDay">◀ Day</button>
  <button id="today">Today</button>
  <button id="nextDay">Day ▶</button>
  <button id="prevGame">◀ Games</button>
  <button id="nextGame">Games ▶</button>
  <input type="date" id="picker" />
  <div class="filters">
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="divisionFilter"><option value="">All Divisions</option></select>
  </div>
  <span id="status" class="muted">Loading…</span>
</header>

<div id="err" class="error"></div>

<div class="wrap">
  <div class="sched">
    <div class="head">
      <div class="timeHead">Time</div>
      <div id="headCols" class="headCols"></div>
    </div>
    <div id="body" class="body" style="--hourPx:60px">
      <div class="timeRail">
        <div id="timeRailInner" class="timeRailInner"></div>
      </div>
      <div id="cols" class="cols"></div>
    </div>
  </div>
</div>

<script>
/* ====== Config (proxy URL included) ====== */
const PROXY_URL = "https://script.google.com/macros/s/AKfycbwV2_TWlOQ_bTS5fo54lvvewR1VNbB2BDs44UQH39Hj79d-w5XHi6NKu4VbBLrIRss7/exec";
const START_HOUR = 7;
const END_HOUR   = 22;
const PX_PER_MIN = 1;     // 60px per hour (1px per minute)
const REFRESH_MS = 60000;

/* ====== State ====== */
let currentDay = new Date();
let allEvents = [], gameDates = [], fields = [];

/* ====== Utils ====== */
const pad=n=>String(n).padStart(2,"0");
const localYMD=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const addDays=(d,n)=>{const x=new Date(d); x.setDate(d.getDate()+n); return x;};
const fmtTime=d=>new Intl.DateTimeFormat([], {hour:"numeric", minute:"2-digit"}).format(d);
const uniq=arr=>[...new Set(arr)];
const nonEmpty=s=>s && String(s).trim().length>0;
function showError(msg){ const box=document.getElementById("err"); box.style.display="block"; box.textContent=msg; }
function clearError(){ const box=document.getElementById("err"); box.style.display="none"; box.textContent=""; }

function detectDivision(txt){ const m=(txt||"").match(/\b(\d{2}U)\b/i); return m?m[1].toUpperCase():""; }
function fieldFromDescription(desc){ if(!desc) return ""; const parts=desc.split(">").map(s=>s.trim()).filter(Boolean); return parts.length?parts[parts.length-1]:""; }
function guessFieldFromText(title, location){
  const hay=(title||"")+" | "+(location||""); let m;
  if (/\bpepper\b.*\bnorth\b/i.test(hay)) return "Pepper North";
  if (/\bpepper\b.*\bsouth\b/i.test(hay)) return "Pepper South";
  if (m=hay.match(/\bmcinnish\b.*\bfield\s*(\d{1,2})\b/i)) return `McInnish Baseball Field ${m[1]}`;
  if (m=hay.match(/\bmac(arthur)?\b.*\b(\d{1,2})\b/i)) return `Mac ${m[2]}`;
  if (/\brdl\b/i.test(hay)) return "RDL";
  if (/\bjaycee\b/i.test(hay)) return "Jaycee Park";
  return (location||"").split(",")[0].trim();
}
function smartSort(a,b){ const key=s=>{ const m=s.match(/^([A-Za-z ]+?)(?:\s+(\d+))?$/); return [(m?.[1]||s).trim().toLowerCase(), Number(m?.[2]||0)]; }; const ka=key(a), kb=key(b); return ka[0]===kb[0]? ka[1]-kb[1] : (ka[0]<kb[0]? -1:1); }

/* ====== Fetch from proxy ====== */
async function fetchEvents(){
  clearError(); const statusEl=document.getElementById("status"); statusEl.textContent="Loading…";
  try{
    const now=new Date();
    const min=new Date(now.getFullYear()-1, now.getMonth(), now.getDate());
    const max=new Date(now.getFullYear()+1, now.getMonth(), now.getDate());
    const url = `${PROXY_URL}?timeMin=${encodeURIComponent(min.toISOString())}&timeMax=${encodeURIComponent(max.toISOString())}`;
    const res = await fetch(url);
    if(!res.ok){ showError(`Proxy error (${res.status}).`); statusEl.textContent="Proxy error."; return; }
    const data = await res.json();
    if(!data || !Array.isArray(data.items)){ showError("Proxy returned unexpected data."); statusEl.textContent="Bad data."; return; }

    allEvents = data.items.map(ev=>{
      const start=ev.start?new Date(ev.start):null;
      const end  =ev.end?new Date(ev.end):start;
      const title=ev.title||"", loc=ev.location||"", desc=ev.description||"";
      const div  =detectDivision(title)||detectDivision(desc);
      let field  =fieldFromDescription(desc);
      if(!field) field = guessFieldFromText(title, loc);
      return { s:start, e:end, t:title, l:loc, desc, div, field };
    }).filter(e=>e.s && e.e);

    fields = uniq(allEvents.map(e=>e.field).filter(nonEmpty)).sort(smartSort);
    gameDates = uniq(allEvents.map(e=>localYMD(e.s))).sort();

    populateFilters();
    render();
    statusEl.textContent=`Loaded ${allEvents.length} events • ${fields.length} fields • ${gameDates.length} game days`;
  }catch(err){ console.error(err); showError("JavaScript error: "+err.message); document.getElementById("status").textContent="Error."; }
}

/* ====== UI ====== */
function populateFilters(){
  const $f=document.getElementById("fieldFilter");
  $f.innerHTML='<option value="">All Fields</option>'+fields.map(f=>`<option>${f}</option>`).join("");
  const divisions=uniq(allEvents.map(e=>e.div).filter(nonEmpty)).sort();
  const $d=document.getElementById("divisionFilter");
  $d.innerHTML='<option value="">All Divisions</option>'+divisions.map(d=>`<option>${d}</option>`).join("");
}

/* Overlap layout per field */
function layoutLevels(events){
  const levels=[]; const placed=[];
  events.sort((a,b)=>a.s-b.s).forEach(ev=>{
    let lvl=0; while(lvl<levels.length && ev.s < levels[lvl]) lvl++;
    levels[lvl]=ev.e; placed.push({ev, level:lvl});
  });
  return { placed, levelCount: Math.max(1, levels.length) };
}

/* ====== Render (absolute positioning by minute) ====== */
function render(){
  const iso=localYMD(currentDay);
  const fieldFilter=document.getElementById("fieldFilter").value;
  const divFilter=document.getElementById("divisionFilter").value;

  const dayStart0=new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),0,0,0,0);
  const dayEnd0  =new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),23,59,59,999);
  const dayStart =new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),START_HOUR,0,0,0);
  const dayEnd   =new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),END_HOUR,0,0,0);
  const totalMin=(END_HOUR-START_HOUR)*60;

  const dayEvents = allEvents
    .filter(ev => ev.e > dayStart0 && ev.s < dayEnd0)
    .filter(ev => !divFilter || ev.div===divFilter)
    .filter(ev => !fieldFilter || ev.field===fieldFilter);

  const colsList = fieldFilter ? [fieldFilter] : fields.slice();

  /* Build sticky header: time + field names (headCols scroll-synced) */
  const headCols = document.getElementById("headCols");
  headCols.innerHTML = colsList.map(f=>`<div class="colHead">${f}</div>`).join("");

  /* Build time rail ticks/labels */
  const hourPx = 60*PX_PER_MIN;
  document.getElementById("body").style.setProperty('--hourPx', hourPx+'px');
  const railInner=document.getElementById("timeRailInner");
  railInner.style.height = (PX_PER_MIN*totalMin) + "px";
  railInner.innerHTML = "";
  for(let h=START_HOUR; h<=END_HOUR; h++){
    const y=(h-START_HOUR)*hourPx;
    railInner.insertAdjacentHTML("beforeend", `<div class="timeTick" style="top:${y}px"></div>`);
    if(h<END_HOUR){
      const dt=new Date(2000,0,1,h,0,0);
      railInner.insertAdjacentHTML("beforeend", `<div class="timeLabel" style="top:${y}px">${new Intl.DateTimeFormat([], {hour:'numeric'}).format(dt)}</div>`);
    }
  }

  /* Build columns and position events */
  const cols = document.getElementById("cols");
  cols.style.gridAutoColumns = 'minmax(140px,1fr)';
  cols.innerHTML = "";
  colsList.forEach(field=>{
    const col=document.createElement('div');
    col.className='col';
    col.style.height = (PX_PER_MIN*totalMin) + "px";

    const es = dayEvents.filter(e=>e.field===field).map(e=>{
      const s = new Date(Math.max(e.s, dayStart));
      const eEnd = new Date(Math.min(e.e, dayEnd));
      return {...e, s, e:eEnd};
    }).filter(e=>e.e>e.s);

    const { placed, levelCount } = layoutLevels(es);

    placed.forEach(({ev, level})=>{
      const topMin  = (ev.s - dayStart)/60000;
      const endMin  = (ev.e - dayStart)/60000;
      const topPx   = Math.round(topMin * PX_PER_MIN * 10) / 10;
      const height  = Math.max(2, Math.round((endMin - topMin) * PX_PER_MIN * 10) / 10);

      const gap=4, widthPct=100/levelCount, leftPct=widthPct*level;

      const node=document.createElement('div');
      node.className='event';
      node.style.top = topPx+'px';
      node.style.height = height+'px';
      node.style.left = `calc(${leftPct}% + ${gap/2}px)`;
      node.style.width = `calc(${widthPct}% - ${gap}px)`;
      node.setAttribute('data-level', level);
      node.title = (ev.l||"").replace(/\s+/g," ").trim();
      node.innerHTML = `
        <div class="time">${fmtTime(ev.s)} – ${fmtTime(ev.e)}</div>
        <div class="title">${ev.t}</div>
        ${ev.div ? `<div class="muted">${ev.div}</div>` : ""}
      `;
      col.appendChild(node);
    });

    cols.appendChild(col);
  });

  /* Sync header scroll with body (field names move with columns) */
  const bodyEl=document.getElementById("body");
  bodyEl.onscroll = () => { headCols.style.transform = `translateX(${-bodyEl.scrollLeft}px)`; };

  document.getElementById("status").textContent=`Showing ${iso} • ${dayEvents.length} events`;
}

/* ====== Navigation ====== */
function jumpToGame(next=true){
  if(!gameDates.length)return;
  const iso=localYMD(currentDay);
  if(next){const nxt=gameDates.find(d=>d>iso);if(nxt){currentDay=new Date(nxt+"T12:00:00");document.getElementById("picker").value=nxt;render();}}
  else{const prev=[...gameDates].reverse().find(d=>d<iso);if(prev){currentDay=new Date(prev+"T12:00:00");document.getElementById("picker").value=prev;render();}}
}

/* ====== Wire up ====== */
document.getElementById("picker").value=localYMD(currentDay);
document.getElementById("prevDay").onclick=()=>{ currentDay=addDays(currentDay,-1); document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("nextDay").onclick=()=>{ currentDay=addDays(currentDay, 1); document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("today").onclick  =()=>{ currentDay=new Date();           document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("prevGame").onclick=()=> jumpToGame(false);
document.getElementById("nextGame").onclick=()=> jumpToGame(true);
document.getElementById("fieldFilter").onchange=render;
document.getElementById("divisionFilter").onchange=render;
document.getElementById("picker").onchange = e=>{ currentDay=new Date(e.target.value+"T12:00:00"); render(); };

/* ====== Init ====== */
fetchEvents();
setInterval(fetchEvents, REFRESH_MS);
</script>
</body>
</html>
