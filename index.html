<script>
const PROXY_URL = "https://script.google.com/macros/s/AKfycbzbd9jhsgVHOyXRcyxJ43vOYOizFNXlJtdOXxo4rDbsTlDBxqowZy4V5OGZ1QAxHtQU/exec"; // e.g., https://script.google.com/macros/s/XXXX/exec
const START_HOUR = 7, END_HOUR = 22, REFRESH_MS = 60000;

let currentDay = new Date();
let allEvents = [], gameDates = [], fields = [];

const pad=n=>String(n).padStart(2,"0");
const localYMD=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const addDays=(d,n)=>{const x=new Date(d); x.setDate(d.getDate()+n); return x;};
const fmtTime=d=>new Intl.DateTimeFormat([], {hour:"numeric", minute:"2-digit"}).format(d);
const uniq=arr=>[...new Set(arr)];
const nonEmpty=s=>s && String(s).trim().length>0;

function detectDivision(txt){ const m=(txt||"").match(/\b(\d{2}U)\b/i); return m?m[1].toUpperCase():""; }
function fieldFromDescription(desc){
  if(!desc) return "";
  const parts = desc.split(">").map(s=>s.trim()).filter(Boolean);
  return parts.length ? parts[parts.length-1] : "";
}
function guessFieldFromText(title, location){
  const hay=(title||"")+" | "+(location||"");
  let m;
  if (/\bpepper\b.*\bnorth\b/i.test(hay)) return "Pepper North";
  if (/\bpepper\b.*\bsouth\b/i.test(hay)) return "Pepper South";
  if (m=hay.match(/\bmcinnish\b.*\bfield\s*(\d{1,2})\b/i)) return `McInnish Baseball Field ${m[1]}`;
  if (m=hay.match(/\bmac(arthur)?\b.*\b(\d{1,2})\b/i)) return `Mac ${m[2]}`;
  if (/\brdl\b/i.test(hay)) return "RDL";
  if (/\bjaycee\b/i.test(hay)) return "Jaycee Park";
  return (location||"").split(",")[0].trim();
}
function smartSort(a,b){
  const key=s=>{ const m=s.match(/^([A-Za-z ]+?)(?:\s+(\d+))?$/); return [(m?.[1]||s).trim().toLowerCase(), Number(m?.[2]||0)]; };
  const ka=key(a), kb=key(b);
  return ka[0]===kb[0]? ka[1]-kb[1] : (ka[0]<kb[0]? -1:1);
}

async function fetchEvents(){
  document.getElementById("status").textContent="Loading…";
  const now=new Date();
  const min=new Date(now.getFullYear()-1, now.getMonth(), now.getDate());
  const max=new Date(now.getFullYear()+1, now.getMonth(), now.getDate());
  const url = `${PROXY_URL}?timeMin=${encodeURIComponent(min.toISOString())}&timeMax=${encodeURIComponent(max.toISOString())}`;
  const res = await fetch(url);
  if(!res.ok){ document.getElementById("status").textContent="Proxy error — check Apps Script deploy & access."; return; }
  const data = await res.json();

  allEvents = (data.items||[]).map(ev=>{
    const start=new Date(ev.start), end=new Date(ev.end||ev.start);
    const title=ev.title||"", loc=ev.location||"", desc=ev.description||"";
    const div = detectDivision(title)||detectDivision(desc);
    let field = fieldFromDescription(desc);
    if(!field) field = guessFieldFromText(title, loc);
    return { s:start, e:end, t:title, l:loc, desc, div, field };
  });

  fields = uniq(allEvents.map(e=>e.field).filter(nonEmpty)).sort(smartSort);
  gameDates = uniq(allEvents.map(e=>localYMD(e.s))).sort();

  populateFilters(); render();
  document.getElementById("status").textContent=`Loaded ${allEvents.length} events • ${fields.length} fields • ${gameDates.length} game days`;
}

function populateFilters(){
  const $f=document.getElementById("fieldFilter");
  $f.innerHTML='<option value="">All Fields</option>'+fields.map(f=>`<option>${f}</option>`).join("");
  const divisions=uniq(allEvents.map(e=>e.div).filter(nonEmpty)).sort();
  const $d=document.getElementById("divisionFilter");
  $d.innerHTML='<option value="">All Divisions</option>'+divisions.map(d=>`<option>${d}</option>`).join("");
}

function render(){
  const iso=localYMD(currentDay);
  const dayStart=new Date(currentDay.getFullYear(), currentDay.getMonth(), currentDay.getDate(),0,0,0,0);
  const dayEnd=new Date(currentDay.getFullYear(), currentDay.getMonth(), currentDay.getDate(),23,59,59,999);

  const fieldFilter=document.getElementById("fieldFilter").value;
  const divFilter=document.getElementById("divisionFilter").value;

  const dayEvents = allEvents
    .filter(ev=>ev.e>dayStart && ev.s<dayEnd)
    .filter(ev=>!divFilter || ev.div===divFilter)
    .filter(ev=>!fieldFilter || ev.field===fieldFilter);

  const cols = fieldFilter ? [fieldFilter] : fields.slice();
  const buckets = Object.fromEntries(cols.map(c=>[c,[]]));
  dayEvents.forEach(ev=>{ if(buckets[ev.field]) buckets[ev.field].push(ev); });

  const hrs = Array.from({length: END_HOUR-START_HOUR+1}, (_,i)=>START_HOUR+i);
  let html = "<thead><tr><th class='time-col'>Time</th>"+cols.map(f=>`<th>${f}</th>`).join("")+"</tr></thead><tbody>";
  for(const h of hrs){
    const slotStart=new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),h,0,0,0);
    const slotEnd=new Date(currentDay.getFullYear(),currentDay.getMonth(),currentDay.getDate(),h+1,0,0,0);
    html+=`<tr><th class="time-col">${new Intl.DateTimeFormat([], {hour:"numeric"}).format(slotStart)}</th>`;
    for(const col of cols){
      const cell=(buckets[col]||[]).filter(ev=>ev.e>slotStart && ev.s<slotEnd)
        .map(ev=>`<div class="event" title="${(ev.l||"").replace(/\s+/g," ").trim()}">
                    <div class="time">${fmtTime(ev.s)} – ${fmtTime(ev.e)}</div>
                    <div class="title">${ev.t}</div>
                    ${ev.div?`<div class="muted">${ev.div}</div>`:""}
                  </div>`).join("");
      html+=`<td>${cell}</td>`;
    }
    html+="</tr>";
  }
  html+="</tbody>";
  document.getElementById("grid").innerHTML=html;
  document.getElementById("status").textContent=`Showing ${iso} • ${dayEvents.length} events`;
}

function jumpToGame(next=true){
  if(!gameDates.length) return;
  const iso=localYMD(currentDay);
  if(next){
    const nxt=gameDates.find(d=>d>iso);
    if(nxt){ currentDay=new Date(nxt+"T12:00:00"); document.getElementById("picker").value=nxt; render(); }
  } else {
    const prev=[...gameDates].reverse().find(d=>d<iso);
    if(prev){ currentDay=new Date(prev+"T12:00:00"); document.getElementById("picker").value=prev; render(); }
  }
}

document.getElementById("picker").value=localYMD(currentDay);
document.getElementById("prevDay").onclick=()=>{ currentDay=addDays(currentDay,-1); document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("nextDay").onclick=()=>{ currentDay=addDays(currentDay, 1); document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("today").onclick  =()=>{ currentDay=new Date();           document.getElementById("picker").value=localYMD(currentDay); render(); };
document.getElementById("prevGame").onclick=()=>jumpToGame(false);
document.getElementById("nextGame").onclick=()=>jumpToGame(true);
document.getElementById("picker").onchange=e=>{ currentDay=new Date(e.target.value+"T12:00:00"); render(); };
document.getElementById("fieldFilter").onchange=render;
document.getElementById("divisionFilter").onchange=render;

fetchEvents();
setInterval(fetchEvents, REFRESH_MS);
</script>
