<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CFBBA Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
<style>
  :root { --bg:#f4f6f8; --card:#fff; --muted:#6b7280; --line:#e5e7eb; --head:#f0f2f5; --accent:#4285f4; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;color:#111}
  header{padding:10px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:3;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button,select,input[type=date]{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  button:hover{background:#fafafa}
  .grid{border-collapse:collapse;width:100%;background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .grid th,.grid td{border:1px solid var(--line);vertical-align:top;padding:8px}
  .grid thead th{background:var(--head);position:sticky;top:60px;z-index:2}
  .time-col{width:80px;background:#fbfbfb;font-weight:600;text-align:center}
  .event{background:#e8f0fe;border-left:4px solid var(--accent);border-radius:6px;margin:4px 0;padding:6px 8px;font-size:13px;line-height:1.25}
  .event .title{font-weight:600}
  .muted{color:var(--muted);font-size:12px}
  .filters{margin-left:auto;display:flex;gap:10px}
  .wrap{padding:12px}
</style>
</head>
<body>
<header>
  <button id="prevDay">◀ Day</button>
  <button id="today">Today</button>
  <button id="nextDay">Day ▶</button>
  <button id="prevGame">◀ Games</button>
  <button id="nextGame">Games ▶</button>
  <input type="date" id="picker">
  <div class="filters">
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="divisionFilter"><option value="">All Divisions</option></select>
    <select id="sortMode">
      <option value="smart">Sort Fields: Complex/Number</option>
      <option value="alpha">Sort Fields: A→Z</option>
    </select>
  </div>
  <span id="status" class="muted"></span>
</header>

<div class="wrap"><table class="grid" id="grid"></table></div>

<script>
/* ============= CONFIG ============= */
const FEED_URL = "https://calendar.bluesombrero.com/api/v1/Calendar?instancekey=leagues&portalId=81458&id=46369345&key=YSOC5AJG";
const START_HOUR = 7;     // grid start
const END_HOUR   = 22;    // grid end
const REFRESH_MS = 60000; // 60s

/* OPTIONAL: precise aliases so headers look exactly like your sample */
const ALIASES = [
  { test:/\bmcinnish\b.*field\s*14/i, to:"McInnish Baseball Field 14" },
  { test:/\bmcinnish\b.*field\s*15/i, to:"McInnish Baseball Field 15" },
  { test:/\bpepper\b.*north/i,        to:"Pepper North" },
  { test:/\bpepper\b.*south/i,        to:"Pepper South" },
  { test:/\bjaycee\b/i,               to:"Jaycee Park"  },
  { test:/\bmac(arthur)?\s*12\b/i,    to:"Mac 12"       },
  { test:/\bmac(arthur)?\s*13\b/i,    to:"Mac 13"       },
  { test:/\bmac(arthur)?\s*14\b/i,    to:"Mac 14"       },
  { test:/\brdl\b/i,                  to:"RDL"          }
];

/* ============= STATE ============= */
let currentDay = new Date();
let allEvents = [];           // {s,e,t,l,div}
let gameDates = [];           // ["YYYY-MM-DD", ...]
let fieldMap = new Map();     // rawField -> friendly
let fieldsFriendly = [];      // ["McInnish Baseball Field 14", ...]
/* ================================= */

const pad=n=>String(n).padStart(2,"0");
const localYMD=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const addDays=(d,n)=>{const x=new Date(d.getTime()); x.setDate(x.getDate()+n); return x;};
const fmtTime=d=>new Intl.DateTimeFormat([], {hour:"numeric", minute:"2-digit"}).format(d);
const uniq=arr=>[...new Set(arr)];
const isNonEmpty=s=>s && String(s).trim().length>0;

/* Detect division tags like 7/8 A National or 10U; here we normalize common "##U" */
function detectDivision(summary){
  const m = (summary||"").match(/\b(\d{2}U)\b/i);
  return m ? m[1].toUpperCase() : "";
}

/* Get a raw "field string" from LOCATION or from "@ Field" in the title */
function rawField(ev){
  if (isNonEmpty(ev.l)) return ev.l;
  const m = (ev.t||"").match(/@(.+)/); // Teams @ McInnish Baseball Field 14
  return m ? m[1].trim() : "";
}

/* Heuristics to convert raw LOCATION lines to friendly field names (no addresses) */
function toFriendly(raw){
  if (!isNonEmpty(raw)) return "";

  // 1) If title-like piece exists after "@", prefer that portion
  let s = String(raw).trim();

  // 2) Try alias rules first (these take precedence)
  for (const a of ALIASES){
    if (a.test.test(s)) return a.to;
  }

  // 3) Split by common separators and evaluate parts
  // Keep parts that look like complex/field labels, drop pure addresses
  const parts = s.split(/[;|\-]|,|\n/).map(p=>p.trim()).filter(Boolean);

  // Heuristics for addresses (we want to skip these)
  const looksLikeAddress = p => /\d{3,5}\s+\w+/.test(p) || /\b(road|rd|lane|ln|drive|dr|street|st|ave|avenue|blvd|tx|texas|dallas|carrollton|richardson|irving|lewisville|zip)\b/i.test(p);

  // Find the best part
  let best = "";
  for (const p of parts){
    if (looksLikeAddress(p)) continue;
    if (/\b(field|north|south|park|complex|pepper|mcinnish|mac|macarthur|rdl|jaycee)\b/i.test(p)) {
      // If it includes "field <num>", keep that number
      const m = p.match(/\bfield\s*(\d+)\b/i);
      if (/\bmcinnish\b/i.test(p) && m) return `McInnish Baseball Field ${m[1]}`;
      if (/\bpepper\b/i.test(p) && /\bnorth\b/i.test(p)) return "Pepper North";
      if (/\bpepper\b/i.test(p) && /\bsouth\b/i.test(p)) return "Pepper South";
      if (/\bmac(arthur)?\b/i.test(p)) {
        const n = (p.match(/\b(\d{1,2})\b/)||[])[1];
        if (n) return `Mac ${n}`;
      }
      if (/\brdl\b/i.test(p)) return "RDL";
      if (/\bjaycee\b/i.test(p)) return "Jaycee Park";
      best = p; // fallback candidate
    }
  }

  // 4) As a last resort, if the raw contains McInnish + number anywhere:
  const m1 = s.match(/\bmcinnish\b.*?\bfield\s*(\d+)\b/i);
  if (m1) return `McInnish Baseball Field ${m1[1]}`;

  // 5) Mac with number
  const m2 = s.match(/\bmac(arthur)?\b.*\b(\d{1,2})\b/i);
  if (m2) return `Mac ${m2[2]}`;

  // 6) Pepper North/South anywhere
  if (/\bpepper\b.*\bnorth\b/i.test(s)) return "Pepper North";
  if (/\bpepper\b.*\bsouth\b/i.test(s)) return "Pepper South";

  // 7) Jaycee
  if (/\bjaycee\b/i.test(s)) return "Jaycee Park";

  // 8) RDL token
  if (/\brdl\b/i.test(s)) return "RDL";

  // 9) Fallback to the first non-address part (if any), else the whole string trimmed
  const nonAddr = parts.find(p=>!looksLikeAddress(p)) || s;
  return nonAddr;
}

/* Smart sort groups by complex then number */
function smartSort(a,b){
  const key = s=>{
    const m = s.match(/([^\d]+)?\s*(\d+)?/);
    return [(m?.[1]||"").trim().toLowerCase(), Number(m?.[2]||0)];
  };
  const ka=key(a), kb=key(b);
  return ka[0]===kb[0] ? ka[1]-kb[1] : (ka[0] < kb[0] ? -1 : 1);
}

/* ---------- LOAD FEED ---------- */
async function loadFeed(){
  document.getElementById("status").textContent = "Loading…";
  const text = await fetch(FEED_URL, { cache:"no-store" }).then(r=>r.text());
  const jcal = ICAL.parse(text);
  const comp = new ICAL.Component(jcal);
  allEvents = comp.getAllSubcomponents("vevent").map(v=>new ICAL.Event(v)).map(e=>({
    s: e.startDate.toJSDate(),
    e: e.endDate.toJSDate(),
    t: e.summary || "",
    l: e.location || "",
    div: detectDivision(e.summary || "")
  }));

  // Build field map raw->friendly
  fieldMap.clear();
  const rawSet = uniq(allEvents.map(ev=>rawField(ev)).filter(isNonEmpty));
  rawSet.forEach(raw => fieldMap.set(raw, toFriendly(raw)));

  // All friendly names (dedup), sorted
  fieldsFriendly = uniq([...fieldMap.values()].filter(isNonEmpty));
  const mode = document.getElementById("sortMode").value;
  fieldsFriendly.sort(mode==="alpha" ? (a,b)=>a.localeCompare(b) : smartSort);

  // Game dates
  gameDates = uniq(allEvents.map(ev => localYMD(ev.s))).sort();

  populateFilters();
  render();
  document.getElementById("status").textContent = `Loaded ${allEvents.length} events • ${fieldsFriendly.length} fields • ${gameDates.length} game days`;
}

/* ---------- UI ---------- */
function populateFilters(){
  // Field filter (friendly headers)
  const $f = document.getElementById("fieldFilter");
  $f.innerHTML = '<option value="">All Fields</option>' + fieldsFriendly.map(f=>`<option>${f}</option>`).join("");

  // Division filter
  const divs = uniq(allEvents.map(e=>e.div).filter(isNonEmpty)).sort();
  const $d = document.getElementById("divisionFilter");
  $d.innerHTML = '<option value="">All Divisions</option>' + divs.map(d=>`<option>${d}</option>`).join("");
}

/* ---------- RENDER GRID ---------- */
function friendlyForEvent(ev){
  const raw = rawField(ev);
  return fieldMap.get(raw) || toFriendly(raw);
}

function render(){
  const iso = localYMD(currentDay);
  const dayStart = new Date(currentDay.getFullYear(), currentDay.getMonth(), currentDay.getDate(), 0,0,0,0);
  const dayEnd   = new Date(currentDay.getFullYear(), currentDay.getMonth(), currentDay.getDate(), 23,59,59,999);

  const fieldFilter = document.getElementById("fieldFilter").value;
  const divFilter   = document.getElementById("divisionFilter").value;

  const todayEvents = allEvents
    .filter(ev => ev.e > dayStart && ev.s < dayEnd)
    .map(ev => ({...ev, field: friendlyForEvent(ev)}))
    .filter(ev => isNonEmpty(ev.field))
    .filter(ev => !divFilter || ev.div === divFilter)
    .filter(ev => !fieldFilter || ev.field === fieldFilter);

  // Prepare columns
  const visibleFields = fieldFilter ? [fieldFilter] : fieldsFriendly.slice();

  // Bucket events by field
  const byField = Object.fromEntries(visibleFields.map(f=>[f, []]));
  todayEvents.forEach(ev => { if (byField[ev.field]) byField[ev.field].push(ev); });

  // Build table
  const hrs = Array.from({length: END_HOUR-START_HOUR+1}, (_,i)=>START_HOUR+i);
  let html = "<thead><tr><th class='time-col'>Time</th>";
  visibleFields.forEach(f => html += `<th>${f}</th>`);
  html += "</tr></thead><tbody>";

  for (const h of hrs){
    const slotStart = new Date(currentDay.getFullYear(), currentDay.getMonth(), currentDay.getDate(), h, 0, 0, 0);
    const slotEnd   = new Date(currentDay.getFullYear(), currentDay.getMonth(), currentDay.getDate(), h+1, 0, 0, 0);
    html += `<tr><th class="time-col">${new Intl.DateTimeFormat([], {hour:"numeric"}).format(slotStart)}</th>`;
    for (const f of visibleFields){
      const cell = (byField[f]||[])
        .filter(ev => ev.e > slotStart && ev.s < slotEnd)
        .map(ev => `<div class="event" title="${(ev.l||"").replace(/\s+/g," ").trim()}">
                      <div class="time">${fmtTime(ev.s)} – ${fmtTime(ev.e)}</div>
                      <div class="title">${ev.t}</div>
                      ${ev.div ? `<div class="muted">${ev.div}</div>` : ""}
                    </div>`).join("");
      html += `<td>${cell}</td>`;
    }
    html += "</tr>";
  }
  html += "</tbody>";
  document.getElementById("grid").innerHTML = html;
  document.getElementById("status").textContent = `Showing ${iso} • ${todayEvents.length} events`;
}

/* ---------- NAV ---------- */
function jumpToGame(next=true){
  if (gameDates.length===0) return;
  const iso = localYMD(currentDay);
  if (next){
    const nxt = gameDates.find(d => d > iso);
    if (nxt){ currentDay = new Date(nxt+"T12:00:00"); document.getElementById("picker").value = nxt; render(); }
  } else {
    const prev = [...gameDates].reverse().find(d => d < iso);
    if (prev){ currentDay = new Date(prev+"T12:00:00"); document.getElementById("picker").value = prev; render(); }
  }
}

/* ---------- WIRE UP ---------- */
document.getElementById("picker").value = localYMD(currentDay);
document.getElementById("prevDay").onclick = ()=>{ currentDay = addDays(currentDay,-1); document.getElementById("picker").value = localYMD(currentDay); render(); };
document.getElementById("nextDay").onclick = ()=>{ currentDay = addDays(currentDay, 1); document.getElementById("picker").value = localYMD(currentDay); render(); };
document.getElementById("today").onclick   = ()=>{ currentDay = new Date();             document.getElementById("picker").value = localYMD(currentDay); render(); };
document.getElementById("prevGame").onclick = ()=> jumpToGame(false);
document.getElementById("nextGame").onclick = ()=> jumpToGame(true);
document.getElementById("picker").onchange  = e => { currentDay = new Date(e.target.value+"T12:00:00"); render(); };
document.getElementById("fieldFilter").onchange = render;
document.getElementById("divisionFilter").onchange = render;
document.getElementById("sortMode").onchange = ()=>{ 
  fieldsFriendly.sort(document.getElementById("sortMode").value==="alpha" ? (a,b)=>a.localeCompare(b) : smartSort);
  populateFilters(); render();
};

/* Init + refresh */
loadFeed();
setInterval(loadFeed, REFRESH_MS);
</script>
</body>
</html>
